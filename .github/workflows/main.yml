name: Build LLVM for Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-aarch64:
    runs-on: ubuntu-22.04
    name: Build for AArch64
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android NDK
      run: |
        # 下载 NDK
        NDK_VERSION="25.2.9519653"
        NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"
        wget -q "https://dl.google.com/android/repository/${NDK_ZIP}"
        unzip -q "${NDK_ZIP}" -d /tmp
        echo "NDK_PATH=/tmp/android-ndk-${NDK_VERSION}" >> $GITHUB_ENV
        
    - name: Clone and setup LLVM
      run: |
        git clone --config core.autocrlf=false \
                  --branch llvmorg-19.1.0 \
                  https://github.com/llvm/llvm-project.git
                  
        # 应用自定义修改
        cp -r llvm/* llvm-project/llvm/ 2>/dev/null || true
        cp -r clang/* llvm-project/clang/ 2>/dev/null || true
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential
        
    - name: Configure and build
      run: |
        cd llvm-project
        mkdir build && cd build
        
        cmake ../llvm \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-21 \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_INCLUDE_TESTS=OFF
          
        ninja -j$(nproc)
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: llvm-aarch64
        path: llvm-project/build/bin/
